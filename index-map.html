<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Коттеджный посёлок «Алхасты» — выбор участка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: row;
    }

    .map-section {
      flex: 2;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar {
      flex: 1;
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    h1 {
      font-size: 24px;
      margin: 0;
    }

    .subtitle {
      margin: 0;
      color: #6b7280;
      font-size: 14px;
    }

    #map {
      flex: 1;
      min-height: 400px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
    }

     .sidebar-title {
      font-size: 18px;
      font-weight: 600;
    }

    .sidebar-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .card {
      border-radius: 12px;
      background: #f9fafb;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
    }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .error-banner {
      background: #fef2f2;
      border: 1px solid #fecdd3;
      color: #991b1b;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 6px 12px rgba(239, 68, 68, 0.08);
    }

    .error-banner strong {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      font-size: 14px;
    }

    .error-banner[hidden] { display: none; }

    .card-main {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .card-extra {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
@@ -215,50 +233,54 @@
      height: 8px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .dot-free       { background:#22c55e; }
    .dot-reserved   { background:#eab308; }
    .dot-sold       { background:#ef4444; }
    .dot-municipal  { background:#3b82f6; }

    @media (max-width: 900px) {
      .page { flex-direction: column; }
      .sidebar { border-top: 1px solid #e5e7eb; }
      #map { min-height: 320px; }
    }
  </style>
</head>
<body>

  <div class="page">
    <section class="map-section">
      <div>
        <h1>Коттеджный посёлок «Алхасты»</h1>
        <p class="subtitle">Выберите участок на карте или в таблице ниже.</p>
      </div>
      <div id="dataError" class="error-banner" role="alert" aria-live="polite" hidden>
        <strong>Не удалось загрузить данные участков</strong>
        <span class="error-message">Попробуйте обновить страницу чуть позже.</span>
      </div>
      <div id="map"></div>
    </section>

    <aside class="sidebar">
      <div>
        <div class="sidebar-title">Выбор участка</div>
        <div class="sidebar-subtitle">
          Кликните по участку на карте или в таблице.
        </div>
      </div>

      <div class="card" id="plotInfoCard">
        <div class="card-label">Выбранный участок</div>
        <div class="card-main" id="plotTitle">Участок не выбран</div>
        <div class="card-extra" id="plotDetails">
          Пожалуйста, выберите участок.
        </div>
      </div>

      <!-- Форма заявки на участок -->
      <form
        id="reservationForm"
        action="https://formsubmit.co/s1410@mail.RU"
        method="POST">

@@ -349,94 +371,118 @@

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>№</th>
            <th>Статус</th>
            <th>Площадь</th>
            <th>Цена</th>
            <th>ВРИ</th>
          </tr>
        </thead>
        <tbody id="plotsTableBody">
        </tbody>
      </table>
    </div>
  </section>

  <!-- Подключение карты -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=9008e2df-de67-4122-b78b-3d37e2ef5617&lang=ru_RU"></script>

  <script>
    let myMap;
    let plotsData = [];
    let selectedPlot = null;
    const dataError = document.getElementById("dataError");
    const dataErrorText = dataError?.querySelector(".error-message");

    function normalizeStatus(status) {
      return (status || "").toLowerCase();
    }

    function statusClass(s) {
      s = s.toLowerCase();
      if (s.includes("муниц")) return "status-municipal";
      if (s.includes("прод")) return "status-sold";
      if (s.includes("резерв")) return "status-reserved";
      const normalized = normalizeStatus(s);
      if (normalized.includes("муниц")) return "status-municipal";
      if (normalized.includes("прод")) return "status-sold";
      if (normalized.includes("резерв")) return "status-reserved";
      return "status-free";
    }

    function dotClass(s) {
      s = s.toLowerCase();
      if (s.includes("муниц")) return "dot-municipal";
      if (s.includes("прод")) return "dot-sold";
      if (s.includes("резерв")) return "dot-reserved";
      const normalized = normalizeStatus(s);
      if (normalized.includes("муниц")) return "dot-municipal";
      if (normalized.includes("прод")) return "dot-sold";
      if (normalized.includes("резерв")) return "dot-reserved";
      return "dot-free";
    }

    function getColorStyle(s) {
      s = s.toLowerCase();
      if (s.includes("муниц")) return {fill:"#60A5FA55",stroke:"#2563EB"};
      if (s.includes("прод")) return {fill:"#EF444455",stroke:"#B91C1C"};
      if (s.includes("резерв")) return {fill:"#FACC1555",stroke:"#CA8A04"};
      const normalized = normalizeStatus(s);
      if (normalized.includes("муниц")) return {fill:"#60A5FA55",stroke:"#2563EB"};
      if (normalized.includes("прод")) return {fill:"#EF444455",stroke:"#B91C1C"};
      if (normalized.includes("резерв")) return {fill:"#FACC1555",stroke:"#CA8A04"};
      return {fill:"#22C55E55",stroke:"#16A34A"};
    }

    function showDataError(message) {
      if (dataErrorText) {
        dataErrorText.textContent = message;
      }
      if (dataError) {
        dataError.hidden = false;
      }
    }

    function init() {
      myMap = new ymaps.Map("map", {
        center: [43.1743, 44.9943],
        zoom: 16,
        type: "yandex#hybrid"
      });

      myMap.controls.remove("trafficControl");
      myMap.controls.remove("fullscreenControl");

      fetch("plotsData.json")
        .then(r => r.json())
        .then(r => {
          if (!r.ok) {
            throw new Error(`Ответ сервера: ${r.status}`);
          }
          return r.json();
        })
        .then(data => {
          plotsData = data;
          renderPlots();
          renderTable();
          setupFilters();
          setupImportExport();
          setupForm();
        })
        .catch(err => {
          console.error("Не удалось загрузить plotsData.json:", err);
          showDataError("Не удалось загрузить данные участков. Попробуйте обновить страницу позже.");
        });
    }

    function renderPlots() {
      plotsData.forEach(plot => {
        const style = getColorStyle(plot.status);

        const polygon = new ymaps.Polygon(
          [ plot.coords.map(p => [p[1], p[0]]) ],
          { hintContent: plot.name },
          {
            fillColor: style.fill,
            strokeColor: style.stroke,
            strokeWidth: 2,
            cursor: "pointer"
          }
        );

        plot.polygon = polygon;
        myMap.geoObjects.add(polygon);

        polygon.events.add("click", () => {
          selectPlot(plot, true);
        });
      });
    }

    function selectPlot(plot, center = false) {
      if (selectedPlot && selectedPlot.polygon) {
        const c = getColorStyle(selectedPlot.status);
        selectedPlot.polygon.options.set({fillColor:c.fill,strokeColor:c.stroke});
      }

      selectedPlot = plot;

      const highlight = {
        fillColor: getColorStyle(plot.status).fill.replace("55","99"),
        strokeColor: getColorStyle(plot.status).stroke
      };
      plot.polygon.options.set(highlight);

      updateSidebar();
      highlightTableRow(plot.id);

      if (center) {
        const bounds = plot.polygon.geometry.getBounds();
        if (bounds) myMap.setBounds(bounds, {checkZoomRange:true});
      }
    }

    function updateSidebar() {
      if (!selectedPlot) return;

      document.getElementById("plotTitle").textContent = selectedPlot.name;
      document.getElementById("plotDetails").innerHTML = `
        <strong>Площадь:</strong> ${selectedPlot.area}<br>
        <strong>Цена:</strong> ${selectedPlot.price}<br>
        <strong>ВРИ:</strong> ${selectedPlot.vri || "-"}<br>
        <strong>Назначение ОКС:</strong> ${selectedPlot.purpose || "-"}<br>
        <strong>Описание:</strong><br>${selectedPlot.projectDescription || "-"}<br>
        <div class="status-pill ${statusClass(selectedPlot.status)}">${selectedPlot.status}</div>
      `;

      // заполняем скрытые поля формы заявки
      const idInput     = document.getElementById("plotIdInput");
      const nameInput   = document.getElementById("plotNameInput");
      const areaInput   = document.getElementById("plotAreaInput");
      const priceInput  = document.getElementById("plotPriceInput");
      const statusInput = document.getElementById("plotStatusInput");

      if (idInput)     idInput.value     = selectedPlot.id ?? "";
      if (nameInput)   nameInput.value   = selectedPlot.name ?? "";
      if (areaInput)   areaInput.value   = selectedPlot.area ?? "";
      if (priceInput)  priceInput.value  = selectedPlot.price ?? "";
      if (statusInput) statusInput.value = selectedPlot.status ?? "";
    }

    function setupForm() {
      const form = document.getElementById("reservationForm");

      form.addEventListener("submit", e => {
        // лёгкая защита: не даём отправить форму без выбранного участка
        if (!selectedPlot) {
          e.preventDefault();
          alert("Пожалуйста, выберите участок на карте или в таблице.");
        }
      });
    }

    function setupFilters() {
      const ids = ["filterStatus","filterAreaMin","filterAreaMax","filterPriceMin","filterPriceMax"];

      ids.forEach(id => {
        document.getElementById(id).addEventListener("input", applyFilters);
      });

      document.getElementById("resetFiltersBtn").addEventListener("click", () => {
        ids.forEach(id => document.getElementById(id).value = "");
        document.getElementById("filterStatus").value = "all";
        applyFilters();
      });
    }

    function applyFilters() {
      const status = document.getElementById("filterStatus").value;
      const amin = parseFloat(document.getElementById("filterAreaMin").value) || null;
      const amax = parseFloat(document.getElementById("filterAreaMax").value) || null;
      const pmin = parseInt(document.getElementById("filterPriceMin").value) || null;
      const pmax = parseInt(document.getElementById("filterPriceMax").value) || null;

      plotsData.forEach(plot => {
        let visible = true;

        if (status !== "all" && plot.status !== status) visible = false;

        const area = plot.areaValue ?? parseFloat(plot.area);
        const price = plot.priceValue ?? parseInt((plot.price||"").replace(/[^\d]/g,""));

        if (amin !== null && area < amin) visible = false;
        if (amax !== null && area > amax) visible = false;

        if (pmin !== null && price < pmin) visible = false;
        if (pmax !== null && price > pmax) visible = false;

        plot.polygon.options.set("visible", visible);
      });

      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById("plotsTableBody");
      tbody.innerHTML = "";

      plotsData.forEach(plot => {
        const visible = plot.polygon.options.get("visible") !== false;
        if (!visible) return;

        const tr = document.createElement("tr");
        tr.dataset.plotId = plot.id;

        tr.innerHTML = `
          <td>${plot.id}</td>
          <td><span class="status-dot ${dotClass(plot.status)}"></span>${plot.status}</td>
          <td>${plot.area}</td>
          <td>${plot.price}</td>
          <td>${plot.vri||"-"}</td>
        `;

        tr.addEventListener("click", () => {
          selectPlot(plot,true);
        });

        tbody.appendChild(tr);
      });
    }

    function highlightTableRow(id) {
      document.querySelectorAll("tbody tr").forEach(tr => {
        tr.classList.toggle("selected-row", tr.dataset.plotId == id);
      });
    }

    function setupImportExport() {
      document.getElementById("exportBtn").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(plotsData,null,2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "plotsData.json";
        a.click();
      });

      document.getElementById("importFile").addEventListener("change", async e => {
        const f = e.target.files[0];
        if (!f) return;

        const text = await f.text();
        const data = JSON.parse(text);

        plotsData = data;
        myMap.geoObjects.removeAll();
        renderPlots();
        renderTable();
      });
    }

    ymaps.ready(init);
  </script>
</body>
</html>
